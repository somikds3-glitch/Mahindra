<script>
document.addEventListener("DOMContentLoaded", () => {
  /* === CONFIG === */
  const CONFIG = {
    LEADS_CSV: "HTML.csv",
    VENDORS_CSV: "vendor.csv",
    GITHUB_API_URL: "https://api.github.com/repos/somikds3-glitch/Mahindra/issues",
    // ⚠️ Replace this with a secure backend relay in production
    GITHUB_PAT: "ghp_yourFineGrainedTokenHere"
  };

  const statusBox   = document.getElementById('status');
  const lastSubmit  = document.getElementById('lastSubmit');
  const emptyState  = document.getElementById('emptyState');
  const errorState  = document.getElementById('errorState');
  const toastEl     = document.getElementById('toast');

  document.getElementById('reloadBtn').addEventListener('click', () => init());
  const setStatus = (msg) => statusBox.textContent = msg;

  /* Globals for filtering */
  let vendors = [];
  let allOpenLeads = [];

  const stateSel = () => document.getElementById('stateFilter');
  const citySel  = () => document.getElementById('cityFilter');
  const uniq     = arr => [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b));

  /* Utilities */
  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(()=> toastEl.classList.remove('show'), 2600);
  }
  function escapeHTML(s){ return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  /* CSV helpers */
  function parseCSV(text){
    const lines   = text.trim().split(/\r?\n/);
    const headers = (lines.shift() || '').split(',').map(h=>h.trim());
    const rows    = lines.filter(Boolean).map(line => {
      const cols = line.split(',').map(c=>c.trim());
      const obj = {}; headers.forEach((h,i)=> obj[h] = cols[i] ?? "");
      return obj;
    });
    return { headers, rows };
  }
  async function fetchCSV(path){
    const res = await fetch(`${path}?_ts=${Date.now()}`);
    if (!res.ok) throw new Error(`Failed to fetch ${path}`);
    const text = await res.text();
    return parseCSV(text);
  }

  /* Init */
  async function init(){
    try{
      setStatus("Loading CSVs…");
      emptyState.style.display = "none";
      errorState.style.display = "none";

      const [leadCSV, vendorCSV] = await Promise.all([
        fetchCSV(CONFIG.LEADS_CSV),
        fetchCSV(CONFIG.VENDORS_CSV)
      ]);

      vendors = vendorCSV.rows;
      allOpenLeads = leadCSV.rows.filter(r => (r.lead_ticket||"").toLowerCase() === "open");

      populateStateOptions(allOpenLeads);
      populateCityOptions(allOpenLeads, "");
      applyFilters();

      setStatus(`Loaded ${allOpenLeads.length} open leads, ${vendors.length} vendors.`);
      showToast("Data refreshed.");
    }catch(err){
      console.error(err);
      setStatus("Error loading data.");
      errorState.style.display = "block";
    }
  }

  /* Filters UI */
  function populateStateOptions(leads){
    const states = uniq(leads.map(l => (l.lead_state||"").trim()));
    stateSel().innerHTML = `<option value="">All states</option>` +
      states.map(s => `<option value="${escapeHTML(s)}">${escapeHTML(s)}</option>`).join("");
  }
  function populateCityOptions(leads, state){
    const cities = uniq(
      leads
        .filter(l => !state || (l.lead_state||"").toLowerCase() === state.toLowerCase())
        .map(l => (l.lead_city||"").trim())
    );
    citySel().innerHTML = `<option value="">All cities</option>` +
      cities.map(c => `<option value="${escapeHTML(c)}">${escapeHTML(c)}</option>`).join("");
  }

  function applyFilters(){
    const s = (stateSel().value || "").toLowerCase();
    const c = (citySel().value  || "").toLowerCase();

    const filtered = allOpenLeads.filter(l =>
      (!s || (l.lead_state||"").toLowerCase() === s) &&
      (!c || (l.lead_city ||"").toLowerCase() === c)
    );

    renderLeadTable(filtered);
    setStatus(`Showing ${filtered.length} of ${allOpenLeads.length} open leads.`);
    emptyState.style.display = filtered.length ? "none" : "block";
  }

  stateSel().addEventListener('change', () => {
    populateCityOptions(allOpenLeads, stateSel().value);
    citySel().value = "";
    applyFilters();
  });
  citySel().addEventListener('change', applyFilters);
  document.getElementById('clearFilters').addEventListener('click', () => {
    stateSel().value = "";
    populateCityOptions(allOpenLeads, "");
    citySel().value = "";
    applyFilters();
  });

  /* Table render */
  function vendorOptionsHTMLForCity(city){
    const list = vendors.filter(v => (v.vendor_city||"").toLowerCase() === (city||"").toLowerCase());
    if (!list.length) return `<option value="">No vendors in ${escapeHTML(city || "this city")}</option>`;
    return list.map(v => {
      const label = `${v.vendor_name} ${v.vendor_subcity ? `(${v.vendor_subcity})` : ""}`;
      const val   = JSON.stringify(v);
      return `<option value='${val.replaceAll("'", "&apos;")}'>${escapeHTML(label)}</option>`;
    }).join("");
  }

  function renderLeadTable(leads){
    const tbody = document.getElementById('leadBody');
    tbody.innerHTML = "";

    for(const r of leads){
      const opts = vendorOptionsHTMLForCity(r.lead_city);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${escapeHTML(r.lead_id)}</strong></td>
        <td>${escapeHTML(r.lead_name)}</td>
        <td>${escapeHTML(r.lead_address)}</td>
        <td>${escapeHTML(r.lead_city)}</td>
        <td>${escapeHTML(r.lead_subcity)}</td>
        <td>${escapeHTML(r.lead_state)}</td>
        <td><span class="pill">${escapeHTML(r.lead_ticket)}</span></td>
        <td class="right">
          <div class="quote-row">
            <select class="vendorSel" aria-label="Select vendor">
              <option value="">Select vendor…</option>
              ${opts}
            </select>
            <input type="number" class="vendorQuote" placeholder="Vendor quote (₹)" inputmode="decimal" min="0" step="0.01" />
            <input type="text" class="note" placeholder="Optional note" maxlength="160" />
            <button class="submitBtn">Submit</button>
          </div>
          <div class="hint">We store: vendor_id, vendor_name, vendor_subcity, vendor_city, vendor_address + quote.</div>
        </td>
      `;
      tr.querySelector('.submitBtn').addEventListener('click', () => handleSubmit(r, tr));
      tbody.appendChild(tr);
    }
  }

  /* Submission → GitHub API */
  async function submitIssue(out){
    const csvHeader = "lead_id,lead_name,lead_address,lead_city,lead_subcity,lead_state,lead_ticket,vendor_id,vendor_name,vendor_quote,vendor_subcity,vendor_city,vendor_address,note";
    const csvRow = [
      out.lead_id,out.lead_name,out.lead_address,out.lead_city,out.lead_subcity,out.lead_state,out.lead_ticket,
      out.vendor_id,out.vendor_name,out.vendor_quote,out.vendor_subcity,out.vendor_city,out.vendor_address,out.note
    ]
    .map(x => (x ?? "").toString().replaceAll('"','""'))
    .map(x => `"${x}"`).join(",");

    const issue = {
      title: "Vendor Quote",
      body: `Please upsert the following row into output.csv\n\n\`\`\`csv\n${csvHeader}\n${csvRow}\n\`\`\`\n\nMeta:\n- Submitted at: ${new Date().toISOString()}\n- Source: GitHub Pages form`
    };

    try {
      const res = await fetch(CONFIG.GITHUB_API_URL, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${CONFIG.GITHUB_PAT}`,
          "Accept": "application/vnd.github+json"
        },
        body: JSON.stringify(issue)
      });

      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      lastSubmit.textContent = `Created GitHub Issue #${data.number} at ${new Date().toLocaleString()}`;
      showToast("Issue created successfully!");
    } catch (err) {
      console.error(err);
      showToast("Failed to create issue.");
    }
  }

  function handleSubmit(lead, rowEl){
    const sel   = rowEl.querySelector('.vendorSel');
    const qEl   = rowEl.querySelector('.vendorQuote');
    const note  = rowEl.querySelector('.note').value.trim();
    const vVal  = sel.value;
    const quote = qEl.value.trim();

    if (!vVal){ showToast("Select a vendor"); sel.focus(); return; }
    if (!quote || isNaN(+quote)){ showToast("Enter a numeric vendor quote"); qEl.focus(); return; }

    const v = JSON.parse(vVal);
    const out = {
      lead_id: lead.lead_id, lead_name: lead.lead_name, lead_address: lead.lead_address,
      lead_city: lead.lead_city, lead_subcity: lead.lead_subcity, lead_state: lead.lead_state,
      lead_ticket: lead.lead_ticket,
      vendor_id: v.vendor_id, vendor_name: v.vendor_name, vendor_quote: quote,
      vendor_subcity: v.vendor_subcity, vendor_city: v.vendor_city, vendor_address: v.vendor_address,
      note
    };

    submitIssue(out);
    qEl.value = ""; rowEl.querySelector('.note').value = ""; sel.selectedIndex = 0;
  }

  // Start once DOM ready
  init();
});
</script>
