<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Leads (Open) & Vendor Quotes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#0c111c; --panel:#0f1626; --ink:#e7eefc; --muted:#9bb0d8; --accent:#5ea0ff; --accent-2:#63f5b8; --ring:rgba(94,160,255,.35); --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.32); --border:rgba(255,255,255,.08); --border-soft:rgba(255,255,255,.06); --font:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--font);color:var(--ink);background:var(--bg)}
    header{padding:20px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .title{font-size:24px;font-weight:700;margin-right:auto}
    button,select,input[type="checkbox"]{background:#121a2b;color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:8px 10px;cursor:pointer}
    button:hover{border-color:var(--accent)}
    .wrap{max-width:1200px;margin:20px auto;padding:20px}
    .panel{background:var(--panel);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{padding:10px;border:1px solid var(--border-soft);text-align:left}
    thead th{background:#0d1526;color:#bcd;position:sticky;top:0;z-index:1}
    .pill{padding:2px 8px;border-radius:8px;background:#1b2238;border:1px solid var(--border)}
    .toast{position:fixed;right:16px;bottom:16px;background:var(--panel);padding:10px 14px;border-radius:8px;border:1px solid var(--border);display:none;box-shadow:var(--shadow)}
    .toast.show{display:block}
    .muted{color:var(--muted)}
    input[type="number"]{width:140px;background:#0e1526;border:1px solid var(--border);color:var(--ink);border-radius:8px;padding:6px 8px}
    #status{font-size:14px;color:var(--muted)}
    #emptyState,#errorState{padding:12px;border:1px dashed var(--border);border-radius:10px;margin-top:10px}
    .row-actions{display:flex;gap:8px;align-items:center}
    .controls{display:flex;gap:10px;align-items:center}
  </style>
</head>
<body>
  <header>
    <div class="title">Leads (Open) & Vendor Quotes</div>
    <div id="status">Ready.</div>
    <div class="controls">
      <label style="display:flex;align-items:center;gap:6px">
        <input type="checkbox" id="onlyOpen" /> Only OPEN
      </label>
      <button id="reloadBtn" title="Reload CSVs">Reload</button>
      <button id="clearFilters" title="Clear filters">Clear</button>
      <button id="pingBtn" title="Ping Apps Script">Ping API</button>
      <button id="debugBtn" title="Show CSV debug" onclick="window.__dbg && window.__dbg()">Debug</button>
      <select id="stateFilter"><option value="">All states</option></select>
      <select id="cityFilter"><option value="">All cities</option></select>
    </div>
  </header>

  <!-- Early bootstrap: keep tiny and bulletproof -->
  <script>
    (function(){
      try{
        var boot = document.getElementById('status');
        if (boot) boot.textContent = 'Bootingâ€¦';
        window.__dbg = function(){
          alert('Debug button is wired. If later UI still fails, a later script crashed.');
        };
        window.__boot_ok = true;
      }catch(e){ /* swallow */ }
    })();
  </script>

  <div class="wrap panel">
    <div id="emptyState" style="display:none;">No leads match your filters.</div>
    <div id="errorState" style="display:none;">Could not load CSVs.</div>

    <table aria-label="Leads">
      <thead>
        <tr>
          <th>Lead ID</th><th>Name</th><th>Address</th><th>City</th>
          <th>Subcity</th><th>State</th><th>Ticket</th><th>Action</th>
        </tr>
      </thead>
      <tbody id="leadBody"></tbody>
    </table>

    <div id="lastSubmit" class="muted" style="margin-top:10px;"></div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
  // Panic overlay â€” strings use 
, never raw newlines
  (function(){
    function paint(msg, src, line, col, err){
      var box=document.createElement('pre');
      box.style.cssText='position:fixed;inset:12px;z-index:99999;background:#1b1b1b;color:#fff;border:1px solid #444;padding:12px;overflow:auto;max-height:90vh;white-space:pre-wrap';
      box.textContent=['ðŸ”¥ JS error:', msg||'', src?('at '+src+':'+(line||0)+':'+(col||0)):'', (err&&err.stack)||''].filter(Boolean).join('
');
      document.body.appendChild(box);
    }
    window.addEventListener('error', function(e){ paint(e.message,e.filename,e.lineno,e.colno,e.error); }, { once:true });
    window.addEventListener('unhandledrejection', function(e){ paint(String((e.reason&&e.reason.stack)||e.reason||'Unhandled promise rejection')); }, { once:true });
  })();
  </script>

  <script>
  document.addEventListener('DOMContentLoaded', function(){
    var CONFIG = {
      CSV_BASE: '',                 // we'll auto-detect below; leave blank
      LEADS_CSV: 'HTML.csv',        // case-sensitive
      VENDORS_CSV: 'vendor.csv',    // case-sensitive
      APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbw6qlBeI-BLoZUZR3uua2RV_vj8DvfDe63R_Fu4FpyP50Rej4cPZXJk9NQ1JTPCkNv7/exec'
    };

    var statusBox   = document.getElementById('status');
    if (window.__boot_ok && statusBox) { statusBox.textContent = 'Boot OK. Startingâ€¦'; }
    var lastSubmit  = document.getElementById('lastSubmit');
    var emptyState  = document.getElementById('emptyState');
    var errorState  = document.getElementById('errorState');
    var toastEl     = document.getElementById('toast');

    var stateSel = document.getElementById('stateFilter');
    var citySel  = document.getElementById('cityFilter');
    var onlyOpen = document.getElementById('onlyOpen');

    var vendors = [];
    var allLeads = [];
    var shownLeads = [];

    function showToast(msg){ toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(function(){ toastEl.classList.remove('show'); }, 2000); }
    function escapeHTML(s){ s = s || ''; return s.replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]; }); }
    function candidateUrlsFor(file){
      var origin = location.origin;
      var p = location.pathname.replace(/\/[^/]*$/, '/'); // current dir
      var up = p.replace(/\/[^/]*\/$/, '/'); // one level up
      var urls = [origin + p + file, origin + '/' + file, origin + up + file];
      var seen = Object.create(null), out=[]; for (var i=0;i<urls.length;i++){ if(!seen[urls[i]]){ seen[urls[i]]=1; out.push(urls[i]); } }
      return out;
    }

    // Robust CSV parser (handles quotes, commas, CR/LF)
    function parseCSV(text){
      var rows = [], row = [], i=0, field='', inQuotes=false, c, n=text.length;
      function pushField(){ row.push(field); field=''; }
      function pushRow(){ rows.push(row); row=[]; }
      while(i<n){
        c = text[i++];
        if(inQuotes){
          if(c === '"'){
            if(i<n && text[i] === '"'){ field += '"'; i++; } else { inQuotes = false; }
          } else { field += c; }
        } else {
          if(c === '"'){ inQuotes = true; }
          else if(c === ','){ pushField(); }
          else if(c === '
'){ /* ignore CR */ }
          else if(c === '
'){ pushField(); pushRow(); }
          else { field += c; }
        }
      }
      pushField();
      if(row.length>1 || (row.length===1 && row[0]!=='' )) pushRow();

      if(rows.length===0) return { headers:[], rows:[] };
      var headers = rows.shift();
      // If nothing but a mega-line was captured, fall back
      if (rows.length === 0 && headers.join(',').indexOf('
') !== -1){
        return parseCSVFallback(text);
      }
      headers = headers.map(function(h){ return String(h||'').trim().toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,''); });
      var objs = rows.map(function(r){ var o={}; for(var j=0;j<headers.length;j++){ o[headers[j]]=(r[j]||'').trim(); } return o; });
      // Normalize to expected keys
      objs = objs.map(function(o){
        var m = Object.create(null); for (var k in o){ m[k]=o[k]; }
        m.lead_id     = m.lead_id||m.id||m.leadid||'';
        m.lead_name   = m.lead_name||m.name||m.lead||'';
        m.lead_address= m.lead_address||m.address||'';
        m.lead_city   = m.lead_city||m.city||'';
        m.lead_subcity= m.lead_subcity||m.subcity||m.area||'';
        m.lead_state  = m.lead_state||m.state||'';
        m.lead_ticket = (m.lead_ticket||m.ticket||m.status||'').trim();
        return m;
      });
      return { headers:headers, rows:objs };
    }

    function parseCSVFallback(text){
      var lines = text.replace(/
/g,'
').replace(/
/g,'
').split('
').filter(function(l){return l.length>0;});
      if (lines.length === 0) return { headers:[], rows:[] };
      var headers = lines.shift().split(',').map(function(h){return h.trim().toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'');});
      var rows = lines.map(function(line){ var cols = line.split(','); var o={}; for (var j=0;j<headers.length;j++){ o[headers[j]] = (cols[j]||'').trim(); } return o; });
      rows = rows.map(function(m){ m.lead_id=m.lead_id||m.id||m.leadid||''; m.lead_name=m.lead_name||m.name||m.lead||''; m.lead_address=m.lead_address||m.address||''; m.lead_city=m.lead_city||m.city||''; m.lead_subcity=m.lead_subcity||m.subcity||m.area||''; m.lead_state=m.lead_state||m.state||''; m.lead_ticket=(m.lead_ticket||m.ticket||m.status||'').trim(); return m; });
      return { headers:headers, rows:rows };
    }

    function fetchCSV(path){
      var tries = candidateUrlsFor(path);
      var tried = [];
      function attempt(i){
        if (i>=tries.length){ throw new Error('All locations failed for '+path+' â†’ '+tried.join(' | ')); }
        var url = tries[i] + (tries[i].indexOf('?')===-1 ? '?_ts=' + Date.now() : '');
        tried.push(url);
        return fetch(url, { cache:'no-store' })
          .then(function(res){ if(!res.ok) throw new Error('HTTP '+res.status); return res.text(); })
          .then(function(txt){ var parsed = parseCSV(txt); if (parsed.rows.length===0){ console.warn('Parsed 0 rows for', url); }
            parsed.__source = url; return parsed; })
          .catch(function(_){ return attempt(i+1); });
      }
      return attempt(0);
    }

    function setStatus(msg){ statusBox.textContent = msg; }
    function uniqueSorted(arr){ var seen = Object.create(null), out = []; for(var i=0;i<arr.length;i++){ var v=(arr[i]||'').trim(); if(!v) continue; if(!seen[v]){ seen[v]=1; out.push(v); } } out.sort(function(a,b){ return a.localeCompare(b); }); return out; }

    function populateStateOptions(rows){ var states = uniqueSorted(rows.map(function(r){ return r.lead_state; })); stateSel.innerHTML = '<option value="">All states</option>' + states.map(function(s){ return '<option value="'+escapeHTML(s)+'">'+escapeHTML(s)+'</option>'; }).join(''); }
    function populateCityOptions(rows, state){ var source = state ? rows.filter(function(r){ return (r.lead_state||'') === state; }) : rows; var cities = uniqueSorted(source.map(function(r){ return r.lead_city; })); citySel.innerHTML = '<option value="">All cities</option>' + cities.map(function(c){ return '<option value="'+escapeHTML(c)+'">'+escapeHTML(c)+'</option>'; }).join(''); }

    function renderLeadTable(leads){
      var tbody = document.getElementById('leadBody');
      tbody.innerHTML = '';
      if(!leads || leads.length===0){ emptyState.style.display = 'block'; return; }
      emptyState.style.display = 'none';
      for(var i=0;i<leads.length;i++){
        var r = leads[i];
        var tr = document.createElement('tr');
        tr.innerHTML =
          '<td>'+escapeHTML(r.lead_id)+'</td>'+
          '<td>'+escapeHTML(r.lead_name)+'</td>'+
          '<td>'+escapeHTML(r.lead_address)+'</td>'+
          '<td>'+escapeHTML(r.lead_city)+'</td>'+
          '<td>'+escapeHTML(r.lead_subcity)+'</td>'+
          '<td>'+escapeHTML(r.lead_state)+'</td>'+
          '<td><span class="pill">'+escapeHTML(r.lead_ticket||'')+'</span></td>'+
          '<td>'+
            '<div class="row-actions">'+
              '<input type="number" class="vendorQuote" placeholder="Quote (â‚¹)" />'+
              '<button class="submitBtn">Submit</button>'+
            '</div>'+
          '</td>';
        (function(lead, rowEl){ var btn = tr.querySelector('.submitBtn'); btn.addEventListener('click', function(){ handleSubmit(lead, rowEl); }); })(r, tr);
        tbody.appendChild(tr);
      }
    }

    function applyFilters(){
      var selState = stateSel.value; var selCity = citySel.value; var openOnly = !!onlyOpen.checked;
      var base = allLeads.slice();
      if (openOnly){ base = base.filter(function(r){ return ((r.lead_ticket||'').trim().toLowerCase().indexOf('open')===0); }); }
      if (openOnly && base.length===0){ base = allLeads.slice(); setStatus('No OPEN rows detected in CSV. Showing ALL rows.'); }
      shownLeads = base.filter(function(r){ var stateOk=!selState || (r.lead_state||'')===selState; var cityOk=!selCity || (r.lead_city||'')===selCity; return stateOk && cityOk; });
      renderLeadTable(shownLeads);
      statusBox.textContent = 'Showing ' + shownLeads.length + ' of ' + allLeads.length + (openOnly?' (OPEN filter on)':'');
    }

    function submitIssue(out){
      fetch(CONFIG.APPS_SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(out) })
      .then(async function(res){ var ct=res.headers.get('content-type')||''; var body = ct.includes('application/json') ? await res.json().catch(function(){return{};}) : await res.text(); return {ok:res.ok,status:res.status,body:body}; })
      .then(function(r){ if (typeof r.body === 'object'){ if(r.body && r.body.ok===true){ lastSubmit.textContent='Saved to Google Sheet.'; showToast('Saved!'); return; } var msg=r.body.error||r.body.message||JSON.stringify(r.body); throw new Error('Server said ('+r.status+'): '+msg); } else { if(r.ok && String(r.body).trim().length===0){ lastSubmit.textContent='Saved.'; showToast('Saved!'); return; } throw new Error('Server did not return JSON ('+r.status+'). First 200 chars:
'+String(r.body).slice(0,200)); } })
      .catch(function(err){ console.error(err); errorState.style.display='block'; errorState.textContent='Submission failed: '+err.message; showToast('Submit failed. See error box.'); });
    }

    function handleSubmit(lead, rowEl){ var qEl=rowEl.querySelector('.vendorQuote'); var quote=(qEl.value||'').trim(); if(!quote){ showToast('Enter a quote'); return; } var out={ lead_id:lead.lead_id, lead_name:lead.lead_name, lead_address:lead.lead_address, lead_city:lead.lead_city, lead_subcity:lead.lead_subcity, lead_state:lead.lead_state, lead_ticket:lead.lead_ticket, note:quote }; submitIssue(out); qEl.value=''; }

    function init(){
      statusBox.textContent = 'Loadingâ€¦'; emptyState.style.display='none'; errorState.style.display='none';
      fetchCSV(CONFIG.LEADS_CSV)
        .then(function(leadCSV){
          allLeads = leadCSV.rows;
          populateStateOptions(allLeads); populateCityOptions(allLeads, '');
          applyFilters();
          statusBox.textContent = 'Loaded ' + allLeads.length + ' leads.' + (leadCSV.__source ? ' (from '+leadCSV.__source+')' : '');
          return fetchCSV(CONFIG.VENDORS_CSV)
            .then(function(vendorCSV){ vendors = vendorCSV.rows; statusBox.textContent += ' ' + vendors.length + ' vendors.'; })
            .catch(function(err){ console.warn('Vendor CSV load failed:', err.message); lastSubmit.textContent = 'Vendor.csv load failed: ' + err.message; });
        })
        .catch(function(err){ console.error(err); statusBox.textContent='Error loading data.'; errorState.style.display='block'; errorState.textContent='Load failed: ' + err.message; });
    }

    // Buttons
    var reloadBtn = document.getElementById('reloadBtn'); if(reloadBtn) reloadBtn.addEventListener('click', function(){ init(); stateSel.value=''; populateCityOptions(allLeads, ''); citySel.value=''; applyFilters(); });
    var clearBtn = document.getElementById('clearFilters'); if(clearBtn) clearBtn.addEventListener('click', function(){ stateSel.value=''; populateCityOptions(allLeads, ''); citySel.value=''; applyFilters(); });
    var pingBtn = document.getElementById('pingBtn'); if (pingBtn) pingBtn.addEventListener('click', function(){ fetch(CONFIG.APPS_SCRIPT_URL, { method:'GET' }).then(function(r){ return r.text().then(function(t){ return {status:r.status, body:t}; }); }).then(function(r){ showToast('API ' + r.status); lastSubmit.textContent = 'Ping response (first 200 chars):
' + String(r.body).slice(0,200); }).catch(function(err){ showToast('Ping failed'); lastSubmit.textContent = 'Ping failed: ' + err.message; }); });
    var debugBtn = document.getElementById('debugBtn'); if (debugBtn) debugBtn.addEventListener('click', function(){
      var leadUrls = candidateUrlsFor(CONFIG.LEADS_CSV).join(' â†’ ');
      var vendUrls = candidateUrlsFor(CONFIG.VENDORS_CSV).join(' â†’ ');
      Promise.all([
        fetch(candidateUrlsFor(CONFIG.LEADS_CSV)[0]).then(function(r){return r.text();}).catch(function(e){return 'ERR:'+e.message;}),
        fetch(candidateUrlsFor(CONFIG.VENDORS_CSV)[0]).then(function(r){return r.text();}).catch(function(e){return 'ERR:'+e.message;})
      ]).then(function(pair){
        var a = pair[0], b = pair[1];
        lastSubmit.textContent = 'HTML.csv tried: '+leadUrls+'
' +
                                 'vendor.csv tried: '+vendUrls+'

' +
                                 'HTML.csv first 200 chars:
' + String(a).slice(0,200) + '

' +
                                 'vendor.csv first 200 chars:
' + String(b).slice(0,200);
      }).catch(function(e){ lastSubmit.textContent = 'Debug failed: '+e.message; });
    });

    // ---- tiny self-tests (do not block UI) ----
    (function selfTests(){
      try{
        var pass=0, fail=0; function expect(cond, msg){ if(cond){pass++;} else {fail++; console.error('TEST FAIL:', msg);} }
        var s1 = 'lead_id,lead_name
1,Alice
2,Bob
';
        var p1 = parseCSV(s1); expect(p1.rows.length===2, 'simple CSV row count'); expect(p1.rows[0].lead_name==='Alice', 'simple CSV field map');
        var s2 = 'lead_id,lead_address
1,"12 Main, Apt 5"
';
        var p2 = parseCSV(s2); expect(p2.rows[0].lead_address==='12 Main, Apt 5', 'quoted comma in field');
        var s3 = 'lead_id,lead_name
3,Carol
';
        var p3 = parseCSV(s3); expect(p3.rows.length===1 && p3.rows[0].lead_name==='Carol', 'CRLF handled');
        if (fail===0){ console.log('Self-tests passed:', pass); } else { console.warn('Self-tests passed:', pass, 'failed:', fail); }
      }catch(e){ console.warn('Self-tests error:', e.message); }
    })();

    // Filters
    stateSel.addEventListener('change', function(){ populateCityOptions(allLeads, stateSel.value); citySel.value=''; applyFilters(); });
    citySel.addEventListener('change', applyFilters);
    onlyOpen.addEventListener('change', applyFilters);

    init();
  });
  </script>
</body>
</html>
