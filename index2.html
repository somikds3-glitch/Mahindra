<script>
document.addEventListener("DOMContentLoaded", () => {
  const CONFIG = {
    LEADS_CSV: "HTML.csv",
    VENDORS_CSV: "vendor.csv",
    GITHUB_API_URL: "https://api.github.com/repos/somikds3-glitch/Mahindra/issues",
    GITHUB_PAT: "REDACTED_TOKEN" // ⚠️ move this server-side in production
  };

  const statusBox   = document.getElementById('status');
  const lastSubmit  = document.getElementById('lastSubmit');
  const emptyState  = document.getElementById('emptyState');
  const errorState  = document.getElementById('errorState');
  const toastEl     = document.getElementById('toast');

  const stateSel    = document.getElementById('stateFilter');
  const citySel     = document.getElementById('cityFilter');

  let vendors = [];
  let allOpenLeads = [];
  let filteredLeads = [];

  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(()=> toastEl.classList.remove('show'), 2500);
  }

  function escapeHTML(s){ return (s||"").replace(/[&<>"']/g,
    m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // simple CSV (no quoted commas); swap for a robust parser if needed
  function parseCSV(text){
    const lines   = text.trim().split(/\r?\n/);
    const headers = (lines.shift() || '').split(',').map(h=>h.trim());
    const rows    = lines.map(line => {
      const cols = line.split(',').map(c=>c.trim());
      const obj = {}; headers.forEach((h,i)=> obj[h] = cols[i] ?? "");
      return obj;
    });
    return { headers, rows };
  }
  async function fetchCSV(path){
    const res = await fetch(`${path}?_ts=${Date.now()}`);
    if (!res.ok) throw new Error(`Failed to fetch ${path}`);
    return parseCSV(await res.text());
  }

  async function init(){
    try {
      statusBox.textContent = "Loading…";
      emptyState.style.display = "none";
      errorState.style.display = "none";

      const [leadCSV, vendorCSV] = await Promise.all([
        fetchCSV(CONFIG.LEADS_CSV),
        fetchCSV(CONFIG.VENDORS_CSV)
      ]);

      vendors = vendorCSV.rows;
      allOpenLeads = leadCSV.rows.filter(r => (r.lead_ticket||"").toLowerCase() === "open");

      // populate filters
      populateStateOptions(allOpenLeads);
      // ensure city list matches current state (initially "All")
      populateCityOptions(allOpenLeads, "");

      // initial render
      filteredLeads = [...allOpenLeads];
      renderLeadTable(filteredLeads);
      setStatus(filteredLeads.length, allOpenLeads.length);
    } catch (err) {
      console.error(err);
      statusBox.textContent = "Error loading data.";
      errorState.style.display = "block";
    }
  }

  function setStatus(count, total){
    statusBox.textContent = `Showing ${count} of ${total} open leads.`;
  }

  function renderLeadTable(leads){
    const tbody = document.getElementById('leadBody');
    tbody.innerHTML = "";
    if (!leads.length) {
      emptyState.style.display = "block";
      return;
    }
    emptyState.style.display = "none";

    for(const r of leads){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHTML(r.lead_id)}</td>
        <td>${escapeHTML(r.lead_name)}</td>
        <td>${escapeHTML(r.lead_address)}</td>
        <td>${escapeHTML(r.lead_city)}</td>
        <td>${escapeHTML(r.lead_subcity)}</td>
        <td>${escapeHTML(r.lead_state)}</td>
        <td><span class="pill">${escapeHTML(r.lead_ticket)}</span></td>
        <td>
          <input type="number" class="vendorQuote" placeholder="Quote (₹)" />
          <button class="submitBtn">Submit</button>
        </td>`;
      tr.querySelector('.submitBtn').addEventListener('click', () => handleSubmit(r, tr));
      tbody.appendChild(tr);
    }
  }

  function uniqueSorted(arr){
    return [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  }

  function populateStateOptions(rows){
    const states = uniqueSorted(rows.map(r => r.lead_state));
    stateSel.innerHTML = `<option value="">All states</option>` +
      states.map(s => `<option value="${escapeHTML(s)}">${escapeHTML(s)}</option>`).join('');
  }

  function populateCityOptions(rows, state){
    const source = state ? rows.filter(r => (r.lead_state||"") === state) : rows;
    const cities = uniqueSorted(source.map(r => r.lead_city));
    citySel.innerHTML = `<option value="">All cities</option>` +
      cities.map(c => `<option value="${escapeHTML(c)}">${escapeHTML(c)}</option>`).join('');
  }

  function applyFilters(){
    const selState = stateSel.value;
    const selCity  = citySel.value;

    filteredLeads = allOpenLeads.filter(r => {
      const stateOk = !selState || (r.lead_state || "") === selState;
      const cityOk  = !selCity  || (r.lead_city  || "") === selCity;
      return stateOk && cityOk;
    });

    renderLeadTable(filteredLeads);
    setStatus(filteredLeads.length, allOpenLeads.length);
  }

  async function submitIssue(out){
    const csvHeader = "lead_id,lead_name,lead_address,lead_city,lead_subcity,lead_state,lead_ticket,note";
    const csvRow = [
      out.lead_id,out.lead_name,out.lead_address,out.lead_city,
      out.lead_subcity,out.lead_state,out.lead_ticket,out.note
    ].map(x => `"${(x ?? "").toString().replaceAll('"','""')}"`).join(",");

    const issue = {
      title: "Vendor Quote",
      body: `Please upsert this row:\n\n\`\`\`csv\n${csvHeader}\n${csvRow}\n\`\`\`\n`
    };

    try {
      const res = await fetch(CONFIG.GITHUB_API_URL, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${CONFIG.GITHUB_PAT}`,
          "Accept": "application/vnd.github+json"
        },
        body: JSON.stringify(issue)
      });
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      lastSubmit.textContent = `Created GitHub Issue #${data.number}`;
      showToast("Issue created successfully!");
    } catch (err) {
      console.error("API failed, fallback:", err);
      window.open("https://github.com/somikds3-glitch/Mahindra/issues/new?title=" +
        encodeURIComponent(issue.title) + "&body=" + encodeURIComponent(issue.body), "_blank");
      showToast("Fallback: opened GitHub issue page.");
    }
  }

  function handleSubmit(lead, rowEl){
    const qEl = rowEl.querySelector('.vendorQuote');
    const quote = qEl.value.trim();
    if (!quote) { showToast("Enter a quote"); return; }

    const out = {
      lead_id: lead.lead_id, lead_name: lead.lead_name, lead_address: lead.lead_address,
      lead_city: lead.lead_city, lead_subcity: lead.lead_subcity, lead_state: lead.lead_state,
      lead_ticket: lead.lead_ticket, note: quote
    };
    submitIssue(out);
    qEl.value = "";
  }

  // Bind buttons
  const reloadBtn = document.getElementById('reloadBtn');
  if (reloadBtn) reloadBtn.addEventListener('click', async () => {
    await init();
    // reset filters after reload
    stateSel.value = "";
    populateCityOptions(allOpenLeads, "");
    citySel.value = "";
    applyFilters();
  });

  const clearBtn = document.getElementById('clearFilters');
  if (clearBtn) clearBtn.addEventListener('click', () => {
    stateSel.value = "";
    populateCityOptions(allOpenLeads, "");
    citySel.value = "";
    applyFilters();
  });

  // Filter listeners
  stateSel.addEventListener('change', () => {
    // repopulate city options scoped to selected state
    populateCityOptions(allOpenLeads, stateSel.value);
    citySel.value = "";
    applyFilters();
  });
  citySel.addEventListener('change', applyFilters);

  init();
});
</script>
