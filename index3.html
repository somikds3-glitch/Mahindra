<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Leads & Vendor Quotes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Segoe UI, sans-serif; margin: 0; padding: 0; background: #0b0f19; color: #e8efff; }
    header { padding: 20px; background: #11182a; }
    h1 { margin: 0; }
    .toolbar { display: flex; gap: 10px; margin: 15px; }
    select, input, button { padding: 8px; border-radius: 5px; border: 1px solid #333; }
    table { width: 100%; border-collapse: collapse; margin: 15px; }
    th, td { padding: 10px; border: 1px solid #333; }
    .pill { background: #222; padding: 4px 8px; border-radius: 20px; font-size: 12px; }
    .right { text-align: right; }
    .status { margin: 15px; color: #9bb0d8; }
  </style>
</head>
<body>
  <header>
    <h1>Leads (Open) & Vendor Quotes</h1>
    <p>Submits to Colab Flask API → Excel via ngrok</p>
  </header>

  <div class="toolbar">
    <label>Filter by State: <select id="stateFilter"><option value="">All States</option></select></label>
    <label>Filter by City: <select id="cityFilter"><option value="">All Cities</option></select></label>
    <button onclick="init()">Reload</button>
  </div>

  <div class="status" id="status">Ready.</div>

  <table id="leadTable">
    <thead>
      <tr>
        <th>Lead ID</th><th>Name</th><th>Address</th><th>City</th>
        <th>Subcity</th><th>State</th><th class="right">Action</th>
      </tr>
    </thead>
    <tbody id="leadBody"></tbody>
  </table>

  <script>
  const CONFIG = {
    LEADS_CSV: "HTML.csv",
    VENDORS_CSV: "vendor.csv",
    API_URL: "https://af832a4e7085.ngrok-free.app/submit" // ✅ your current ngrok URL
  };

  const statusBox = document.getElementById("status");
  const tbody = document.getElementById("leadBody");
  const stateSel = document.getElementById("stateFilter");
  const citySel = document.getElementById("cityFilter");

  const setStatus = msg => statusBox.textContent = msg;

  // CSV helpers
  function parseCSV(text) {
    const lines = text.trim().split("\n");
    const headers = lines.shift().split(",");
    return lines.map(line => {
      const cols = line.split(",");
      const obj = {};
      headers.forEach((h,i)=> obj[h.trim()] = cols[i] ? cols[i].trim() : "");
      return obj;
    });
  }

  async function fetchCSV(file) {
    const res = await fetch(file);
    return parseCSV(await res.text());
  }

  // Filters
  function uniqueSorted(list){ return [...new Set(list.filter(Boolean))].sort(); }

  function populateStateOptions(leads) {
    const states = uniqueSorted(leads.map(r => r.lead_state));
    stateSel.innerHTML = '<option value="">All States</option>' +
      states.map(s=>`<option value="${s}">${s}</option>`).join("");
  }

  function populateCityOptions(leads, stateVal) {
    const src = stateVal ? leads.filter(r => r.lead_state === stateVal) : leads;
    const cities = uniqueSorted(src.map(r => r.lead_city));
    citySel.innerHTML = '<option value="">All Cities</option>' +
      cities.map(c=>`<option value="${c}">${c}</option>`).join("");
  }

  // Render
  function renderLeadTable(leads, vendors) {
    tbody.innerHTML = "";
    leads.forEach(lead => {
      const vendorOptions = vendors.filter(v=>v.vendor_city===lead.lead_city)
        .map(v=>`<option value='${JSON.stringify(v)}'>${v.vendor_name}</option>`)
        .join("");

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${lead.lead_id}</td>
        <td>${lead.lead_name}</td>
        <td>${lead.lead_address}</td>
        <td>${lead.lead_city}</td>
        <td>${lead.lead_subcity}</td>
        <td>${lead.lead_state}</td>
        <td class="right">
          <select class="vendorSel"><option value="">Select vendor…</option>${vendorOptions}</select>
          <input type="number" class="vendorQuote" placeholder="Quote (₹)" />
          <input type="text" class="note" placeholder="Note" />
          <button onclick="submitForm(this)">Submit</button>
        </td>
      `;
      tr.dataset.lead = JSON.stringify(lead);
      tbody.appendChild(tr);
    });
  }

  // Submit
  async function submitForm(btn) {
    const tr = btn.closest("tr");
    const lead = JSON.parse(tr.dataset.lead);
    const vendor = JSON.parse(tr.querySelector(".vendorSel").value || "{}");
    const quote = tr.querySelector(".vendorQuote").value;
    const note = tr.querySelector(".note").value;

    if (!vendor.vendor_name) { alert("Choose vendor"); return; }
    if (!quote) { alert("Enter quote"); return; }

    const payload = {
      lead_id: lead.lead_id,
      lead_name: lead.lead_name,
      lead_address: lead.lead_address,
      lead_city: lead.lead_city,
      lead_subcity: lead.lead_subcity,
      lead_state: lead.lead_state,
      vendor_name: vendor.vendor_name,
      vendor_quote: quote,
      note: note
    };

    try {
      setStatus("Submitting…");
      const res = await fetch(CONFIG.API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const resp = await res.json();
      console.log("Response:", resp);
      setStatus("✅ Submitted to Colab API");
    } catch (err) {
      console.error(err);
      setStatus("❌ Submit failed: " + err.message);
    }
  }

  // Init
  async function init() {
    try {
      setStatus("Loading data…");
      const [leads, vendors] = await Promise.all([
        fetchCSV(CONFIG.LEADS_CSV),
        fetchCSV(CONFIG.VENDORS_CSV)
      ]);
      const openLeads = leads.filter(r => (r.lead_ticket||"").toLowerCase() === "open");
      populateStateOptions(openLeads);
      populateCityOptions(openLeads, "");
      renderLeadTable(openLeads, vendors);

      stateSel.onchange = () => {
        populateCityOptions(openLeads, stateSel.value);
        filterAndRender(openLeads, vendors);
      };
      citySel.onchange = () => filterAndRender(openLeads, vendors);

      setStatus(`Loaded ${openLeads.length} open leads, ${vendors.length} vendors`);
    } catch (err) {
      console.error(err);
      setStatus("Error loading data: " + err.message);
    }
  }

  function filterAndRender(leads, vendors) {
    let filtered = leads;
    if (stateSel.value) filtered = filtered.filter(r=>r.lead_state===stateSel.value);
    if (citySel.value) filtered = filtered.filter(r=>r.lead_city===citySel.value);
    renderLeadTable(filtered, vendors);
    setStatus(`Showing ${filtered.length} leads`);
  }

  init();
  </script>
</body>
</html>
