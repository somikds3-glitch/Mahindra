<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Absence Tracker + Deductions (Google Sheets)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root {
    --bg: #0b0f19;
    --panel: #10182b;
    --ink: #e8efff;
    --ink-dim: #bcd0ff;
    --accent: #71a1ff;
    --red: #ff6b6b;
    --green: #2ecc71;
  }
  * { box-sizing: border-box; }
  body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg); color: var(--ink); }
  header { padding: 18px 20px; background: #11182a; border-bottom: 1px solid #1a2743; display: flex; justify-content: space-between; align-items: center; }
  header h1 { margin: 0; font-size: 18px; }
  select#language { padding: 6px 10px; border-radius: 8px; border: 1px solid #333; background: #0f1424; color: var(--ink); }
  .wrap { padding: 16px; max-width: 1100px; margin: 0 auto; }
  .controls { display: grid; gap: 12px; grid-template-columns: 1fr; }
  .row { display: grid; gap: 10px; grid-template-columns: 1fr 140px 260px 160px; }
  input[type="text"], input[type="number"], select, button {
    width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #223255; background: #0f1424; color: var(--ink);
  }
  button { background: var(--accent); border-color: transparent; color: #071121; font-weight: 600; cursor: pointer; }
  button:disabled { opacity: .6; cursor: not-allowed; }
  .status { margin-top: 8px; color: var(--ink-dim); font-size: 13px; }
  .grid { display: grid; gap: 16px; grid-template-columns: 1fr; margin-top: 18px; }
  @media (min-width: 900px) { .grid { grid-template-columns: 1.2fr .8fr; } }

  .card { background: var(--panel); border: 1px solid #1a2743; border-radius: 14px; padding: 14px; }
  .card h2 { margin: 0 0 8px; font-size: 16px; color: var(--ink); }
  table { width: 100%; border-collapse: collapse; font-size: 14px; }
  th, td { text-align: left; padding: 10px 8px; border-bottom: 1px solid #1a2743; }
  th { color: var(--ink-dim); font-weight: 600; }
  .right { text-align: right; }
  .money { font-variant-numeric: tabular-nums; }
  .bad { color: var(--red); }
  .totals { display: flex; gap: 12px; flex-wrap: wrap; margin: 10px 0 0; }
  .totals .pill { font-weight: 600; }
  .muted { color: var(--ink-dim); }
  .pill { background: #0e1730; border: 1px solid #23345f; padding: 4px 8px; border-radius: 999px; }
</style>
</head>
<body>
<header>
  <h1 id="title">Absence Tracker + Monthly Deductions</h1>
  <select id="language">
    <option value="en">English</option>
    <option value="bn">বাংলা</option>
    <option value="bi">Bilingual</option>
  </select>
</header>

<div class="wrap">
  <div class="controls card">
    <div class="row">
      <input id="sheetUrl" type="text" placeholder="Paste Google Sheets share URL here" value="https://docs.google.com/spreadsheets/d/1JzuAzh3l05X5kmwIY6dmTTX3kQeNH3ZTnb7oDz1Osdw/edit?usp=sharing" />
      <input id="salary" type="number" min="0" step="0.01" value="4500" title="Monthly salary (override)" />
      <select id="rateBasis">
        <option value="30">Per-day rate = salary / 30 (default)</option>
        <option value="calendar">Per-day rate = salary / calendar days in month</option>
      </select>
      <button id="loadBtn">Load</button>
    </div>
    <div class="status" id="status">Waiting for a Google Sheets URL. Sheet1 = absences (Date, Day). Sheet2 = finance (Monthly Pay, Balance, ...).</div>
  </div>

  <div class="grid">
    <div class="card">
      <h2 id="absTitle">Absence Dates</h2>
      <table id="datesTable">
        <thead><tr><th>#</th><th>Date</th><th>Day</th><th class="right">Month</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h2 id="sumTitle">Monthly Summary & Deductions</h2>
      <table id="summaryTable">
        <thead><tr>
          <th>Month</th><th class="right">Absences</th><th class="right">Per-day rate</th><th class="right">Deduction</th><th class="right">Net Salary</th>
        </tr></thead>
        <tbody></tbody>
      </table>
      <div class="totals" id="totals"></div>
      <div class="status muted" id="balanceStatus">Remaining balance from Sheet2 will appear here.</div>
    </div>
  </div>
</div>

<script>
const translations = {
  en: { title:'Absence Tracker + Monthly Deductions', absTitle:'Absence Dates', sumTitle:'Monthly Summary & Deductions', balance:'Remaining balance from Sheet2 will appear here.', waiting:'Waiting for a Google Sheets URL. Sheet1 = absences (Date, Day). Sheet2 = finance (Monthly Pay, Balance, ...).'},
  bn: { title:'অনুপস্থিতি ট্র্যাকার ও মাসিক কর্তন হিসাব', absTitle:'অনুপস্থিতির তারিখসমূহ', sumTitle:'মাসিক সারসংক্ষেপ ও কর্তন', balance:'Sheet2 থেকে বাকি ব্যালেন্স এখানে দেখা যাবে।', waiting:'গুগল শীটের লিংক দিন। Sheet1 = অনুপস্থিতি (তারিখ, দিন), Sheet2 = বেতন সংক্রান্ত তথ্য।'},
  bi: { title:'Absence Tracker / অনুপস্থিতি ট্র্যাকার', absTitle:'Absence Dates / অনুপস্থিতির তারিখ', sumTitle:'Monthly Summary & Deductions / মাসিক সারসংক্ষেপ ও কর্তন', balance:'Remaining balance / Sheet2 থেকে বাকি ব্যালেন্স।', waiting:'Paste Google Sheets URL / গুগল শীটের লিংক দিন।'}
};

function setLanguage(lang){
  const t = translations[lang];
  document.getElementById('title').textContent = t.title;
  document.getElementById('absTitle').textContent = t.absTitle;
  document.getElementById('sumTitle').textContent = t.sumTitle;
  document.getElementById('balanceStatus').textContent = t.balance;
  document.getElementById('status').textContent = t.waiting;
}

document.getElementById('language').addEventListener('change', e => setLanguage(e.target.value));
setLanguage('en');

function extractSheetId(url){ const m=String(url).match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/); return m?m[1]:null; }
function csvUrls(id,sheet){ return [ `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv&sheet=${sheet}`, `https://docs.google.com/spreadsheets/d/${id}/export?format=csv&sheet=${sheet}` ]; }

async function fetchCSV(urls){ for(const u of urls){ try{ const r=await fetch(u,{cache:'no-store'}); if(r.ok)return parseCSV(await r.text()); }catch(e){console.warn('fail',u,e);} } throw new Error('All CSV endpoints failed.'); }

function parseCSV(text){const lines=text.split(/\r?\n/).filter(Boolean);const h=lines.shift().split(',');return lines.map(l=>{const v=l.split(',');const o={};h.forEach((hh,i)=>o[hh.trim()]=v[i]?v[i].trim():'');return o;});}
function parseDate(v){const t=v.trim();const d=new Date(t);if(!isNaN(d))return d;const m=t.match(/(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})/);if(m){return new Date(m[3],m[2]-1,m[1]);}return null;}
function monthKey(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');}
function monthLabel(k){const[y,m]=k.split('-');return new Date(y,m-1,1).toLocaleString(undefined,{month:'long',year:'numeric'});} 
function currency(n){return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});}

const btn=document.getElementById('loadBtn');
btn.onclick=async()=>{
  const id=extractSheetId(document.getElementById('sheetUrl').value);
  if(!id){document.getElementById('status').textContent='Invalid Sheet URL';return;}
  btn.disabled=true;document.getElementById('status').textContent='Loading...';
  try{
    const sheet1=await fetchCSV(csvUrls(id,'Sheet1'));
    const sheet2=await fetchCSV(csvUrls(id,'Sheet2'));
    document.getElementById('status').textContent='Sheets loaded successfully';
    console.log(sheet1,sheet2);
  }catch(e){
    document.getElementById('status').textContent='Error loading: '+e.message;
  }finally{btn.disabled=false;}
};
</script>
</body>
</html>
