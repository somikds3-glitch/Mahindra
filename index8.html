<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Absence Tracker + Deductions (Google Sheets)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root {
    --bg: #0b0f19;
    --panel: #10182b;
    --ink: #e8efff;
    --ink-dim: #bcd0ff;
    --accent: #71a1ff;
    --red: #ff6b6b;
    --green: #2ecc71;
  }
  * { box-sizing: border-box; }
  body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg); color: var(--ink); }
  header { padding: 18px 20px; background: #11182a; border-bottom: 1px solid #1a2743; display: flex; justify-content: space-between; align-items: center; }
  header h1 { margin: 0; font-size: 18px; }
  select#language { padding: 6px 10px; border-radius: 8px; border: 1px solid #333; background: #0f1424; color: var(--ink); }
  .wrap { padding: 16px; max-width: 1100px; margin: 0 auto; }
  .controls { display: grid; gap: 12px; grid-template-columns: 1fr; }
  .row { display: grid; gap: 10px; grid-template-columns: 1fr 140px 260px 160px; }
  input[type="text"], input[type="number"], select, button {
    width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #223255; background: #0f1424; color: var(--ink);
  }
  button { background: var(--accent); border-color: transparent; color: #071121; font-weight: 600; cursor: pointer; }
  button:disabled { opacity: .6; cursor: not-allowed; }
  .status { margin-top: 8px; color: var(--ink-dim); font-size: 13px; }
  .grid { display: grid; gap: 16px; grid-template-columns: 1fr; margin-top: 18px; }
  @media (min-width: 900px) { .grid { grid-template-columns: 1.2fr .8fr; } }

  .card { background: var(--panel); border: 1px solid #1a2743; border-radius: 14px; padding: 14px; }
  .card h2 { margin: 0 0 8px; font-size: 16px; color: var(--ink); }
  table { width: 100%; border-collapse: collapse; font-size: 14px; }
  th, td { text-align: left; padding: 10px 8px; border-bottom: 1px solid #1a2743; }
  th { color: var(--ink-dim); font-weight: 600; }
  .right { text-align: right; }
  .money { font-variant-numeric: tabular-nums; }
  .bad { color: var(--red); }
  .totals { display: flex; gap: 12px; flex-wrap: wrap; margin: 10px 0 0; }
  .totals .pill { font-weight: 600; }
  .muted { color: var(--ink-dim); }
  .pill { background: #0e1730; border: 1px solid #23345f; padding: 4px 8px; border-radius: 999px; }
  .bigpay { font-size: 28px; font-weight: 900; margin-top: 14px; letter-spacing: 0.2px; }
</style>
</head>
<body>
<header>
  <h1 id="title">Absence Tracker + Monthly Deductions</h1>
  <select id="language">
    <option value="en">English</option>
    <option value="bn">বাংলা</option>
    <option value="bi">Bilingual</option>
  </select>
</header>

<div class="wrap">
  <div class="controls card">
    <div class="row">
      <input id="sheetUrl" type="text" placeholder="Paste Google Sheets share URL here" value="https://docs.google.com/spreadsheets/d/1JzuAzh3l05X5kmwIY6dmTTX3kQeNH3ZTnb7oDz1Osdw/edit?usp=sharing" />
      <input id="salary" type="number" min="0" step="0.01" value="4500" title="Monthly salary (override)" />
      <select id="rateBasis">
        <option value="30">Per-day rate = salary / 30 (default)</option>
        <option value="calendar">Per-day rate = salary / calendar days in month</option>
      </select>
      <button id="loadBtn">Load</button>
    </div>
    <div class="status" id="status">Waiting for a Google Sheets URL. Sheet1 = absences (Date, Day). Sheet2 = finance (Monthly Pay, Balance, ...).</div>
  </div>

  <div class="grid">
    <div class="card">
      <h2 id="absTitle">Absence Dates</h2>
      <table id="datesTable">
        <thead><tr><th>#</th><th>Date</th><th>Day</th><th class="right">Month</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h2 id="sumTitle">Monthly Summary & Deductions</h2>
      <table id="summaryTable">
        <thead><tr>
          <th>Month</th><th class="right">Absences</th><th class="right">Per-day rate</th><th class="right">Deduction</th><th class="right">Net Salary</th>
        </tr></thead>
        <tbody></tbody>
      </table>
      <div class="totals" id="totals"></div>
      <div id="nextPayBig" class="bigpay"></div>
      <div class="status muted" id="balanceStatus">Remaining balance from Sheet2 will appear here.</div>
    </div>
  </div>
</div>

<script>
const translations = {
  en: { title:'Absence Tracker + Monthly Deductions', absTitle:'Absence Dates', sumTitle:'Monthly Summary & Deductions', balance:'Remaining balance from Sheet2 will appear here.', waiting:'Waiting for a Google Sheets URL. Sheet1 = absences (Date, Day). Sheet2 = finance (Monthly Pay, Balance, ...).', adjustedLabel:'Next month to be paid (adjusted): '},
  bn: { title:'অনুপস্থিতি ট্র্যাকার ও মাসিক কর্তন হিসাব', absTitle:'অনুপস্থিতির তারিখসমূহ', sumTitle:'মাসিক সারসংক্ষেপ ও কর্তন', balance:'Sheet2 থেকে বাকি ব্যালেন্স এখানে দেখা যাবে।', waiting:'গুগল শীটের লিংক দিন। Sheet1 = অনুপস্থিতি (তারিখ, দিন), Sheet2 = বেতন সংক্রান্ত তথ্য।', adjustedLabel:'আগামী মাসে প্রদানযোগ্য (সমন্বয়ের পর): '},
  bi: { title:'Absence Tracker / অনুপস্থিতি ট্র্যাকার', absTitle:'Absence Dates / অনুপস্থিতির তারিখ', sumTitle:'Monthly Summary & Deductions / মাসিক সারসংক্ষেপ ও কর্তন', balance:'Remaining balance / Sheet2 থেকে বাকি ব্যালেন্স।', waiting:'Paste Google Sheets URL / গুগল শীটের লিংক দিন।', adjustedLabel:'Next month (adjusted) / আগামী মাসে (সমন্বয়): '}
};

let currentLang = 'en';
function setLanguage(lang){
  currentLang = lang;
  const t = translations[lang];
  document.getElementById('title').textContent = t.title;
  document.getElementById('absTitle').textContent = t.absTitle;
  document.getElementById('sumTitle').textContent = t.sumTitle;
  document.getElementById('balanceStatus').textContent = t.balance;
  document.getElementById('status').textContent = t.waiting;
}

document.getElementById('language').addEventListener('change', e => setLanguage(e.target.value));
setLanguage('en');

// Helpers
function extractSheetId(url){ const m=String(url).match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/); return m?m[1]:null; }
function csvUrls(id,sheet){ return [ `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheet)}`, `https://docs.google.com/spreadsheets/d/${id}/export?format=csv&sheet=${encodeURIComponent(sheet)}` ]; }

async function fetchCSV(urls){
  let lastErr;
  for(const u of urls){
    try{ const r=await fetch(u,{cache:'no-store'}); if(r.ok){ const t=await r.text(); return parseCSV(t); } lastErr = new Error(`HTTP ${r.status} ${r.statusText}`); }
    catch(e){ lastErr=e; }
  }
  throw lastErr || new Error('All CSV endpoints failed');
}

// CSV parser that handles quotes and commas inside quotes
function parseCSV(text){
  const out=[]; let i=0, f='', row=[], inQ=false; const pushF=()=>{row.push(f); f='';}; const pushR=()=>{out.push(row); row=[];};
  while(i<text.length){ const c=text[i];
    if(c==='"'){ if(inQ && text[i+1]==='"'){ f+='"'; i++; } else { inQ=!inQ; } }
    else if(c===',' && !inQ){ pushF(); }
    else if((c==='\n'||c==='\r') && !inQ){ if(c==='\r'&&text[i+1]==='\n') i++; pushF(); pushR(); }
    else { f+=c; }
    i++;
  }
  pushF(); if(row.length) pushR();
  if(!out.length) return [];
  const headers = out[0].map(h=>h.trim());
  return out.slice(1).filter(r=>r.some(v=>v && v.trim()!=='')).map(r=>{
    const obj={}; headers.forEach((h,idx)=> obj[h]= (r[idx]||'').trim()); return obj;
  });
}

function keyFind(obj, ...names){
  const keys = Object.keys(obj||{});
  for(const n of names){ const k = keys.find(k=>k.toLowerCase().trim()===n.toLowerCase().trim()); if(k) return k; }
  return null;
}

function parseDateLoose(v){
  const t = String(v||'').trim(); if(!t) return null; let d=new Date(t); if(!isNaN(d)) return d;
  const m=t.match(/^(\d{1,2})[\/. -](\d{1,2})[\/. -](\d{2,4})$/); if(m){ const d1=Number(m[1]); const m1=Number(m[2]); const y1=Number(m[3].length===2?('20'+m[3]):m[3]); d=new Date(y1, m1-1, d1); if(!isNaN(d)) return d; }
  return null;
}

function monthKey(d){ return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0'); }
function monthLabel(k){ const parts=k.split('-'); const y=Number(parts[0]); const m=Number(parts[1]); return new Date(y,m-1,1).toLocaleDateString(undefined,{month:'long',year:'numeric'}); }
function daysInMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0).getDate(); }
function currency(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }

// Rendering
function renderDates(records){
  const body = document.querySelector('#datesTable tbody');
  body.innerHTML = records.map((r,i)=>`<tr><td>${i+1}</td><td>${r.date.toLocaleDateString()}</td><td>${r.day}</td><td class=\"right\">${monthLabel(r.mkey)}</td></tr>`).join('') || `<tr><td colspan=\"4\" class=\"muted\">No valid dates found in Sheet1.</td></tr>`;
}

function renderSummary(records, salary, basis){
  const body = document.querySelector('#summaryTable tbody');
  const byMonth = new Map();
  for(const r of records){ if(!byMonth.has(r.mkey)) byMonth.set(r.mkey, []); byMonth.get(r.mkey).push(r); }
  let totalAbs=0, totalDed=0; const rows=[];
  for(const [mkey, items] of [...byMonth.entries()].sort()){
    const any = items[0].date;
    const perDay = basis==='calendar' ? (salary / daysInMonth(any)) : (salary / 30);
    const count = items.length;
    const ded = perDay * count;
    totalAbs += count; totalDed += ded;
    rows.push(`<tr><td>${monthLabel(mkey)}</td><td class=\"right\">${count}</td><td class=\"right money\">${currency(perDay)}</td><td class=\"right money bad\">-${currency(ded)}</td><td class=\"right money\">${currency(Math.max(0, salary - ded))}</td></tr>`);
  }
  body.innerHTML = rows.join('') || `<tr><td colspan=\"5\" class=\"muted\">No absences to summarize.</td></tr>`;
  document.getElementById('totals').innerHTML = `<span class=\"pill\">Total absences: ${totalAbs}</span><span class=\"pill bad\">Total deduction: -${currency(totalDed)}</span><span class=\"pill\">Monthly salary: ${currency(salary)}</span><span class=\"pill\">Rate basis: ${document.getElementById('rateBasis').selectedOptions[0].textContent}</span>`;
  return { totalAbs, totalDed };
}

function renderBalance(sheet2, totals){
  let msg = '';
  let highlight = '';
  const t = translations[currentLang];
  if(sheet2.length){
    const row = sheet2[0];
    const payKey = keyFind(row, 'Monthly Pay','MonthlyPay','Monthly Salary');
    const balKey = keyFind(row, 'Balance','Remaining Balance','RemainingBalance','Other misconceptions. balance');
    const lastPaidKey = keyFind(row, 'Last Month Paid','Last Paid');
    const nextPayKey = keyFind(row, 'Next Month to be paid','Next To Pay');

    const bal = balKey ? Number(String(row[balKey]).replace(/[^\d.-]/g,'')) : NaN;
    const nextToPay = nextPayKey ? Number(String(row[nextPayKey]).replace(/[^\d.-]/g,'')) : NaN;
    const lastPaid = lastPaidKey ? Number(String(row[lastPaidKey]).replace(/[^\d.-]/g,'')) : NaN;

    if(!isNaN(bal)){
      const after = bal - totals.totalDed;
      msg = `Balance (Sheet2): ${currency(bal)}. Total deductions: ${currency(totals.totalDed)}. After deductions: ${currency(after)}.`;
      if(!isNaN(lastPaid)) msg += ` Last month paid: ${currency(lastPaid)}.`;
    } else {
      msg = 'Sheet2 loaded but no recognizable Balance field found.';
    }

    // Highlight: next month to be paid adjusted by total deduction
    if(!isNaN(nextToPay)){
      const adjusted = nextToPay - totals.totalDed;
      highlight = `${t.adjustedLabel}${currency(adjusted)}`;
    }
  } else {
    msg = 'Sheet2 appears empty. Skipping remaining balance.';
  }
  document.getElementById('balanceStatus').textContent = msg;
  document.getElementById('nextPayBig').textContent = highlight;
}

// Main load
const btn=document.getElementById('loadBtn');
btn.onclick=async()=>{
  const id=extractSheetId(document.getElementById('sheetUrl').value);
  if(!id){ document.getElementById('status').textContent='Invalid Sheet URL'; return; }
  btn.disabled=true; document.getElementById('status').textContent='Loading...';
  try{
    const [sheet1, sheet2] = await Promise.all([
      fetchCSV(csvUrls(id,'Sheet1')),
      fetchCSV(csvUrls(id,'Sheet2'))
    ]);

    // Salary: prefer Sheet2 Monthly Pay if present, else input value
    let salary = Number(document.getElementById('salary').value || 0);
    if(sheet2.length){
      const payKey = keyFind(sheet2[0], 'Monthly Pay','MonthlyPay','Monthly Salary');
      if(payKey){ const s = Number(String(sheet2[0][payKey]).replace(/[^\d.-]/g,'')); if(!isNaN(s) && s>0){ salary = s; document.getElementById('salary').value = String(s); } }
    }

    // Build records from Sheet1
    if(!sheet1.length) throw new Error('Sheet1 appears empty.');
    const dKey = keyFind(sheet1[0], 'Date','Absence Date','Absent Date');
    let dayKey = keyFind(sheet1[0], 'Day');
    if(!dKey) throw new Error("Sheet1 needs a 'Date' column.");

    const records = [];
    sheet1.forEach((r, idx)=>{
      const d = parseDateLoose(r[dKey]||''); if(!d) return; // skip invalid
      let dayName = dayKey ? (r[dayKey]||'') : '';
      if(!dayName) dayName = d.toLocaleDateString(undefined,{weekday:'long'});
      records.push({ idx: idx+1, date: d, day: dayName, mkey: monthKey(d) });
    });
    records.sort((a,b)=> a.date - b.date);

    renderDates(records);
    const totals = renderSummary(records, salary, document.getElementById('rateBasis').value);
    renderBalance(sheet2, totals);

    document.getElementById('status').textContent='Sheets loaded successfully';
  }catch(e){
    console.error(e);
    document.getElementById('status').textContent='Error loading: '+e.message;
    document.querySelector('#datesTable tbody').innerHTML='';
    document.querySelector('#summaryTable tbody').innerHTML='';
    document.getElementById('totals').innerHTML='';
    document.getElementById('nextPayBig').textContent='';
    document.getElementById('balanceStatus').textContent='';
  }finally{ btn.disabled=false; }
};
</script>
</body>
</html>
